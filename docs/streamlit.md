

# VerdeSat B‑Score v0.1 — Investor‑Demo Dashboard (Streamlit)

## 1 · Goals & Design Principles
| # | Principle | Implication |
|---|-----------|-------------|
| 1 | **Show, don’t tell** | Map, gauges, and plots must be visible within **≤ 10 s** for demo AOIs. |
| 2 | **Hybrid runtime** | *Instant* demo via pre‑baked datasets **+** option to run a **live compute** (≤ 8 min on 1 km²). |
| 3 | **No‑code onboarding** | Stakeholder can drag‑drop a GeoJSON and click **Run**. |
| 4 | **Extensible** | New metrics/layers plug in without touching UI skeleton. |
| 5 | **Cheap to host** | Single Streamlit container (free tier or 256 MB Fly.io). |

---

## 2 · Feature Set (v0.1)

| Area | Must‑Have | Nice‑to‑Have (stretch) |
|------|-----------|------------------------|
| **AOI Input** | • Drag‑and‑drop GeoJSON/Shapefile<br>• Inline map‑draw tool (rectangle/polygon) | • Multi‑AOI batch upload (GeoJSON FC) |
| **Compute Modes** | • 🔘 *Demo Mode* (pre‑baked results for 3 showcase AOIs)<br>• 🔘 *Live Mode* (calls MetricEngine + MSAService & caches to R2) | • Queue + email callback for > 1 km² |
| **Visual Map** | • Leaflet map (`streamlit‑folium`) with layer checklist:<br>  ☐ AOI boundary (vector)<br>  ☐ Land‑cover 10 m (Esri)<br>  ☐ Annual **NDVI** composite<br>  ☐ Annual **MSAVI** composite | • Swipe comparator (before/after)<br>• Basemap switcher (Sat / OSM / Terrain) |
| **Metrics Display** | • KPI cards: Intactness %, Shannon, Fragmentation‑Norm, **NDVI stats**, **MSAVI stats**, B‑Score gauge (0‑100). | • Hover tool‑tips with metric definitions |
| **Charts** | • **NDVI time‑series decomposition plot** (observed / trend / seasonal)<br>• **MSAVI annual bar‑plot** | • Radar chart of all metrics |
| **Exports** | • `Download CSV` (metrics)<br>• `Download PDF` (WeasyPrint → fallback pdfkit) | • GeoTIFF raster bundle (.zip) |
| **Branding** | • Hero logo + VerdeSat colours (#159466 / #212324). | • Dark‑mode toggle |
| **Logging & Feedback** | • Real‑time progress bar (`st.progress`) | • Toast for quota errors |

---

## 3 · UX Flow (single‑page)

```
Sidebar (320 px)                Main Canvas
-------------------------------------------------------------
  [VerdeSat logo]               |  Map (70 % vh)
  Mode ▸ Demo / Upload          |   ├─ Layer checklist
  Year ▸ slider 2017‑2024       |   └─ Interactive map
  Weights ▸ sliders             |  ────────────────────────────
  Compute ▸ button              |  KPI Row (6 cards)
  Progress bar                  |  ────────────────────────────
                                |  Tabs: [NDVI Decomp] [MSAVI] [About]
-------------------------------------------------------------
Footer: “Generated by VerdeSat B‑Score v0.1 — cc‑by‑sa”
```

---

## 4 · Data & Runtime Strategy  

| Component | Source | Latency | Cache Layer |
|-----------|--------|---------|-------------|
| Land‑cover 10 m | Esri TS (GEE) | 2‑5 s | R2 `lc/{hash}/{year}.tif` |
| **Annual NDVI composite** | Sentinel‑2 SR (GEE) | 3‑4 s | R2 `ndvi/{hash}/{year}.tif` |
| **Annual MSAVI composite** | Sentinel‑2 SR (GEE) | 3‑4 s | R2 `msavi/{hash}/{year}.tif` |
| **NDVI decomposition stats** | Statsmodels / SciPy | 1‑2 s | Redis 24 h TTL |
| **MSAVI stats** | Numpy | <1 s | Redis 24 h TTL |

All live results cached with `@st.cache_data(hash_funcs=…)`.

---

## 5 · Code‑Level Architecture

```
verdesat/
├─ webapp/
│   ├─ app.py               # Streamlit entry
│   ├─ state.py             # session helpers
│   ├─ components/
│   │   ├─ map_widget.py
│   │   ├─ kpi_cards.py
│   │   └─ charts.py
│   ├─ services/
│   │   ├─ compute.py       # orchestrates MetricEngine + NDVI/MSAVI
│   │   └─ cache.py         # R2 + Redis
│   └─ themes/verdesat.css
└─ core/ (existing modules)
```

---

## 6 · Implementation Stages & Steps

| Stage | Calendar | Key Deliverables | Acceptance |
|-------|----------|------------------|-------------|
| **0 · Prep** | Day 0 (½ day) | • Decide hosting (Streamlit Cloud vs Fly).<br>• Create `webapp/` package and blank `app.py`. | Repo scaffold committed. |
| **1 · Skeleton UI** | Day 1 | • Sidebar controls, empty map.<br>• Load pre‑baked demo AOI from R2.<br>• Custom CSS/theme. | App loads at `localhost:8501`. |
| **2 · Map Layers** | Day 2‑3 | • Map widget with AOI + land‑cover + NDVI & MSAVI composites.<br>• Layer checklist and opacity slider. | Layers toggle without errors. |
| **3 · Metrics & KPIs** | Day 4‑5 | • Intactness/Shannon/Frag‑Norm cards.<br>• NDVI & MSAVI statistical cards.<br>• B‑Score gauge. | Values match CLI for demo AOI. |
| **4 · Charts Tab** | Day 6 | • NDVI STL decomposition plot.<br>• MSAVI annual bar‑plot.<br>• Caching enabled. | Charts render <2 s. |
| **5 · Live Compute Mode** | Day 7‑8 | • Wire `compute.py` to MetricEngine.<br>• R2 write‑back.<br>• Progress bar + error handling. | Compute 1 km² AOI <8 min. |
| **6 · Exports** | Day 9 | • CSV + PDF export buttons.<br>• PDF via WeasyPrint fallback. | Files download w/ correct data. |
| **7 · Polish & Deploy** | Day 10 | • Favicon, hero logo, dark‑mode.<br>• CNAME `app.verdesat.com` set.<br>• Password protect via env var. | Demo to investors runs smoothly. |

---

## 7 · KPI Targets

| Metric | Goal |
|--------|------|
| Demo AOI load time | **< 10 s** |
| Live compute ≤1 km² | **< 8 min** |
| Memory footprint | **< 400 MB** |
| Concurrent demo sessions | ≥ 5 |

---

## 8 · Road‑Map Hooks (v0.2+)

* GEDI canopy height, SAR biomass layers (extra TileLayers).  
* User accounts & Stripe pay‑wall.  
* React/Next.js re‑skin using same FastAPI endpoints.  
* Webhooks for completed runs & shared report URLs.

---

## 9 · Acceptance Criteria (Milestone “Dashboard v0.1”)

1. **Demo Mode** loads Spain pilot AOI in < 10 s on Streamlit Cloud.  
2. KPI cards & B‑Score gauge match CLI outputs.  
3. Map layers toggle NDVI & MSAVI composites correctly.  
4. NDVI decomposition and MSAVI plots render in Charts tab.  
5. CSV & PDF exports download with valid data.  
6. `app.verdesat.com` serves the dashboard over HTTPS.

---

## 10 · Configuration

The Streamlit app reads settings from `verdesat/resources/webapp.toml`:

```toml
[demo]
aoi_key = "resources/reference.geojson"

[[demo.aois]]
id = 1
name = "AOI 1"
ndvi = "resources/NDVI_1_2024-01-01.tif"
msavi = "resources/MSAVI_1_2024-01-01.tif"

[[demo.aois]]
id = 2
name = "AOI 2"
ndvi = "resources/NDVI_2_2024-01-01.tif"
msavi = "resources/MSAVI_2_2024-01-01.tif"

[defaults]
start_year = 2019
end_year = 2024

[r2]
endpoint = "${R2_ENDPOINT}"
bucket = "${R2_BUCKET}"
key = "${R2_KEY}"
secret = "${R2_SECRET}"

[cache]
redis_url = "${REDIS_URL}"
```

`r2.endpoint`, `r2.key` and `r2.secret` are required; other keys have
defaults. Environment variables referenced in `${...}` are expanded at load
time.