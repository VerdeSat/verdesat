

# VerdeSat Bâ€‘ScoreÂ v0.1 â€” Investorâ€‘Demo Dashboard (Streamlit)

## 1Â Â·Â Goals & Design Principles
| # | Principle | Implication |
|---|-----------|-------------|
| 1 | **Show, donâ€™t tell** | Map, gauges, and plots must be visible within **â‰¤â€¯10â€¯s** for demo AOIs. |
| 2 | **Hybrid runtime** | *Instant* demo via preâ€‘baked datasets **+** option to run a **live compute** (â‰¤â€¯8â€¯min on 1â€¯kmÂ²). |
| 3 | **Noâ€‘code onboarding** | Stakeholder can dragâ€‘drop a GeoJSON and click **Run**. |
| 4 | **Extensible** | New metrics/layers plug in without touching UI skeleton. |
| 5 | **Cheap to host** | Single Streamlit container (free tier or 256â€¯MB Fly.io). |

---

## 2Â Â·Â Feature Set (v0.1)

| Area | Mustâ€‘Have | Niceâ€‘toâ€‘Have (stretch) |
|------|-----------|------------------------|
| **AOI Input** | â€¢ Dragâ€‘andâ€‘drop GeoJSON/Shapefile<br>â€¢ Inline mapâ€‘draw tool (rectangle/polygon) | â€¢ Multiâ€‘AOI batch upload (GeoJSON FC) |
| **Compute Modes** | â€¢ ğŸ”˜ *Demo Mode* (preâ€‘baked results for 3 showcase AOIs)<br>â€¢ ğŸ”˜ *Live Mode* (calls MetricEngine + MSAService & caches to R2) | â€¢ Queue + email callback for >â€¯1â€¯kmÂ² |
| **Visual Map** | â€¢ Leaflet map (`streamlitâ€‘folium`) with layer checklist:<br>  â˜ AOI boundary (vector)<br>  â˜ Landâ€‘cover 10â€¯m (Esri)<br>  â˜ Annual **NDVI** composite<br>  â˜ Annual **MSAVI** composite | â€¢ Swipe comparator (before/after)<br>â€¢ Basemap switcher (Satâ€¯/â€¯OSMâ€¯/â€¯Terrain) |
| **Metrics Display** | â€¢ KPI cards: Intactnessâ€¯%, Shannon, Fragmentationâ€‘Norm, **NDVI stats**, **MSAVI stats**, Bâ€‘Score gauge (0â€‘100). | â€¢ Hover toolâ€‘tips with metric definitions |
| **Charts** | â€¢ **NDVI timeâ€‘series decomposition plot** (observed / trend / seasonal)<br>â€¢ **MSAVI annual barâ€‘plot** | â€¢ Radar chart of all metrics |
| **Exports** | â€¢ `Downloadâ€¯CSV` (metrics)<br>â€¢ `Downloadâ€¯PDF` (WeasyPrint â†’ fallback pdfkit) | â€¢ GeoTIFF raster bundle (.zip) |
| **Branding** | â€¢ Hero logo + VerdeSat colours (#159466 / #212324). | â€¢ Darkâ€‘mode toggle |
| **Logging & Feedback** | â€¢ Realâ€‘time progress bar (`st.progress`) | â€¢ Toast for quota errors |

---

## 3Â Â·Â UX Flow (singleâ€‘page)

```
Sidebar (320â€¯px)                Main Canvas
-------------------------------------------------------------
  [VerdeSatÂ logo]               |  Map (70â€¯% vh)
  Mode â–¸ Demo / Upload          |   â”œâ”€ Layer checklist
  Year â–¸ slider 2017â€‘2024       |   â””â”€ Interactive map
  Weights â–¸ sliders             |  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Compute â–¸ button              |  KPI Row (6 cards)
  Progress bar                  |  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                |  Tabs: [NDVI Decomp] [MSAVI] [About]
-------------------------------------------------------------
Footer: â€œGenerated by VerdeSatÂ Bâ€‘ScoreÂ v0.1 â€” ccâ€‘byâ€‘saâ€
```

---

## 4Â Â·Â Data & Runtime Strategy  

| Component | Source | Latency | Cache Layer |
|-----------|--------|---------|-------------|
| Landâ€‘cover 10â€¯m | EsriÂ TS (GEE) | 2â€‘5Â s | R2 `lc/{hash}/{year}.tif` |
| **Annual NDVI composite** | Sentinelâ€‘2 SR (GEE) | 3â€‘4Â s | R2 `ndvi/{hash}/{year}.tif` |
| **Annual MSAVI composite** | Sentinelâ€‘2 SR (GEE) | 3â€‘4Â s | R2 `msavi/{hash}/{year}.tif` |
| **NDVI decomposition stats** | Statsmodels / SciPy | 1â€‘2Â s | Redis 24â€¯h TTL |
| **MSAVI stats** | Numpy | <1â€¯s | Redis 24â€¯h TTL |

All live results cached with `@st.cache_data(hash_funcs=â€¦)`.

---

## 5Â Â·Â Codeâ€‘Level Architecture

```
verdesat/
â”œâ”€ webapp/
â”‚   â”œâ”€ app.py               # Streamlit entry
â”‚   â”œâ”€ state.py             # session helpers
â”‚   â”œâ”€ components/
â”‚   â”‚   â”œâ”€ map_widget.py
â”‚   â”‚   â”œâ”€ kpi_cards.py
â”‚   â”‚   â””â”€ charts.py
â”‚   â”œâ”€ services/
â”‚   â”‚   â”œâ”€ compute.py       # orchestrates MetricEngine + NDVI/MSAVI
â”‚   â”‚   â””â”€ cache.py         # R2 + Redis
â”‚   â””â”€ themes/verdesat.css
â””â”€ core/ (existing modules)
```

---

## 6Â Â·Â Implementation Stages & Steps

| Stage | Calendar | Key Deliverables | Acceptance |
|-------|----------|------------------|-------------|
| **0Â Â·â€¯Prep** | DayÂ 0 (Â½â€¯day) | â€¢ Decide hosting (StreamlitÂ Cloud vsÂ Fly).<br>â€¢ Create `webapp/` package and blank `app.py`. | Repo scaffold committed. |
| **1Â Â·â€¯Skeleton UI** | DayÂ 1 | â€¢ Sidebar controls, empty map.<br>â€¢ Load preâ€‘baked demo AOI from R2.<br>â€¢ Custom CSS/theme. | App loads at `localhost:8501`. |
| **2Â Â·â€¯Map Layers** | DayÂ 2â€‘3 | â€¢ Map widget with AOI + landâ€‘cover + NDVI & MSAVI composites.<br>â€¢ Layer checklist and opacity slider. | Layers toggle without errors. |
| **3Â Â·â€¯Metrics & KPIs** | DayÂ 4â€‘5 | â€¢ Intactness/Shannon/Fragâ€‘Norm cards.<br>â€¢ NDVI & MSAVI statistical cards.<br>â€¢ Bâ€‘Score gauge. | Values match CLI for demo AOI. |
| **4Â Â·â€¯Charts Tab** | DayÂ 6 | â€¢ NDVI STL decomposition plot.<br>â€¢ MSAVI annual barâ€‘plot.<br>â€¢ Caching enabled. | Charts render <2â€¯s. |
| **5Â Â·â€¯Live Compute Mode** | DayÂ 7â€‘8 | â€¢ Wire `compute.py` to MetricEngine.<br>â€¢ R2 writeâ€‘back.<br>â€¢ Progress bar + error handling. | Compute 1â€¯kmÂ² AOI <8â€¯min. |
| **6Â Â·â€¯Exports** | DayÂ 9 | â€¢ CSV + PDF export buttons.<br>â€¢ PDF via WeasyPrint fallback. | Files download w/ correct data. |
| **7Â Â·â€¯Polish & Deploy** | DayÂ 10 | â€¢ Favicon, hero logo, darkâ€‘mode.<br>â€¢ CNAME `app.verdesat.com` set.<br>â€¢ Password protect via env var. | Demo to investors runs smoothly. |

---

## 7Â Â·Â KPI Targets

| Metric | Goal |
|--------|------|
| Demo AOI load time | **<â€¯10â€¯s** |
| Live compute â‰¤1â€¯kmÂ² | **<â€¯8â€¯min** |
| Memory footprint | **<â€¯400â€¯MB** |
| Concurrent demo sessions | â‰¥â€¯5 |

---

## 8Â Â·Â Roadâ€‘Map Hooks (v0.2+)

* GEDI canopy height, SAR biomass layers (extra TileLayers).  
* User accounts & Stripe payâ€‘wall.  
* React/Next.js reâ€‘skin using same FastAPI endpoints.  
* Webhooks for completed runs & shared report URLs.

---

## 9Â Â·Â Acceptance Criteria (Milestone â€œDashboardâ€¯v0.1â€)

1. **Demo Mode** loads Spain pilot AOI in <â€¯10â€¯s on Streamlit Cloud.  
2. KPI cards & Bâ€‘Score gauge match CLI outputs.  
3. Map layers toggle NDVI & MSAVI composites correctly.  
4. NDVI decomposition and MSAVI plots render in Charts tab.  
5. CSV & PDF exports download with valid data.  
6. `app.verdesat.com` serves the dashboard over HTTPS.

---

## 10 Â· Configuration

The Streamlit app reads settings from `verdesat/resources/webapp.toml`:

```toml
[demo]
aoi_key = "resources/reference.geojson"

[[demo.aois]]
id = 1
name = "AOI 1"
ndvi = "resources/NDVI_1_2024-01-01.tiff"
msavi = "resources/MSAVI_1_2024-01-01.tiff"

[[demo.aois]]
id = 2
name = "AOI 2"
ndvi = "resources/NDVI_2_2024-01-01.tiff"
msavi = "resources/MSAVI_2_2024-01-01.tiff"

[defaults]
start_year = 2019
end_year = 2024

[r2]
endpoint = "${R2_ENDPOINT}"
bucket = "${R2_BUCKET}"
key = "${R2_KEY}"
secret = "${R2_SECRET}"

[cache]
redis_url = "${REDIS_URL}"
```

`r2.endpoint`, `r2.key` and `r2.secret` are required; other keys have
defaults. Environment variables referenced in `${...}` are expanded at load
time.