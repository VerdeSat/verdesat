<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{ report_title or "VerdeSat Evidence Pack" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    {{ print_css|safe }}
  </style>
</head>
<body>
  <header class="vs-header">
    <div class="brand">VerdeSat</div>
    <div class="meta">
      <div>{{ report_date }}</div>
      <div>AOI: {{ aoi_name }} ({{ aoi_id }})</div>
      <div>Method v{{ method_version }} • Hash {{ report_hash[:8] if report_hash else '' }}</div>
    </div>
  </header>

  <main>
    <!-- HERO / EXEC SUMMARY -->
    <section class="hero">
      <h1>Biodiversity & Forest‑Health Screening</h1>
      <p class="subhead">CSRD/TNFD‑friendly indicators. Screening‑grade; best for forests. Not a species inventory.</p>
      <div class="summary-grid">
        <div class="panel">
          <div class="kpi-label">B‑Score</div>
          <div class="bscore">
            {% if bscore is defined and bscore is not none %}
              {{ bscore|round(0) }}/100
            {% else %}
              –
            {% endif %}
          </div>
          <div class="band {{ bscore_band|default('')|lower }}">{{ bscore_band_label|default('') }}</div>
          {% set w = weights|default({}) %}
          <div class="kpi-note">Weights: I {{ w.intactness|default('') }} / S {{ w.shannon|default('') }} / F {{ w.fragmentation|default('') }}</div>
        </div>
        <figure class="map">
          <img src="{{ map_png }}" alt="AOI map with overlay" />
          <figcaption>AOI boundary and latest composite ({{ acquisition_from }} → {{ acquisition_to }})</figcaption>
        </figure>
        <div class="kpi-strip">
          <div class="kpi"><span>Intactness</span><strong>{{ intactness_pct|default(0)|float|round(2) }}%</strong></div>
          <div class="kpi"><span>Frag‑Norm</span><strong>{{ frag_norm|default(0)|float|round(2) }}</strong></div>
          <div class="kpi"><span>MSA</span><strong>{{ msa|default(0)|float|round(2) }}</strong></div>
          <div class="kpi"><span>NDVI μ</span><strong>{{ ndvi_mean|default(0)|float|round(2) }}</strong></div>
          <div class="kpi"><span>NDVI slope/yr</span><strong>{{ ndvi_slope|default(0)|float|round(2) }}</strong></div>
          <div class="kpi"><span>NDVI p-value</span><strong>{{ ndvi_p_value|default(0)|float|round(3) }}</strong></div>
          <div class="kpi"><span>ΔNDVI YoY</span><strong>{{ ndvi_delta|default(0)|float|round(2) }}</strong></div>
          <div class="kpi"><span>% valid obs</span><strong>{{ valid_obs_pct|default(0)|float|round(2) }}%</strong></div>
        </div>
      </div>
      <p class="executive">{{ executive_summary }}</p>
    </section>

    <!-- PROTECTED AREAS / SENSITIVITY -->
    <section>
      <h2>Context: Protected & Sensitive Areas</h2>
      <table class="simple">
        <thead><tr><th>Inside PA?</th><th>Nearest PA</th><th>Distance</th><th>Nearest KBA</th><th>Distance</th></tr></thead>
        <tbody>
          <tr>
            <td>{{ inside_pa|default(false) and 'Yes' or 'No' }}</td>
            <td>{{ nearest_pa_name or '–' }}</td>
            <td>{{ nearest_pa_distance_km is not none and (nearest_pa_distance_km|round(2) ~ ' km') or '–' }}</td>
            <td>{{ nearest_kba_name or '–' }}</td>
            <td>{{ nearest_kba_distance_km is not none and (nearest_kba_distance_km|round(2) ~ ' km') or '–' }}</td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- TRENDS -->
    <section>
      <h2>Vegetation Trends</h2>
      <figure class="plot">
        <img src="{{ ndvi_png }}" alt="NDVI trend" />
        <figcaption>NDVI trend for all AOIs.</figcaption>
      </figure>
      <figure class="plot">
        <img src="{{ msavi_png }}" alt="Yearly MSAVI" />
        <figcaption>Yearly mean MSAVI for all AOIs.</figcaption>
      </figure>
    </section>

    <!-- ESRS E4 MAPPING -->
    <section>
      <h2>ESRS E4 Mapping (screening)</h2>
      <table class="kv">
        <tr><th>Extent & Condition</th><td>{{ esrs_extent_condition }}</td></tr>
        <tr><th>Pressures</th><td>{{ esrs_pressures }}</td></tr>
        <tr><th>Targets</th><td>{{ esrs_targets }}</td></tr>
        <tr><th>Actions & Resources</th><td>{{ esrs_actions }}</td></tr>
        <tr><th>Anticipated Financial Effects</th><td>{{ esrs_financial_effects }}</td></tr>
      </table>
      <p class="disclaimer">Screening‑grade outputs. Field validation recommended for regulatory sign‑off.</p>
    </section>

    <!-- DATA & METHODS -->
    <section>
      <h2>Methods & Limitations</h2>
      <ul class="bullets">
        <li>AOI aggregation to handle mixed resolutions (10 m ↔ 300 m); report pixel counts and % valid observations.</li>
        <li>MSA 2015 (300 m) used as pressure context; vintage and coarseness disclosed.</li>
        <li>NDVI saturation in dense canopies considered in interpretation; seasonal decomposition applied.</li>
      </ul>
      <p>{{ methods_text }}</p>
      <h3>Data lineage</h3>
      <pre class="code">{{ lineage_json|tojson(indent=2) }}</pre>
      <h3>Sources</h3>
      <table class="simple">
        <thead><tr><th>Name</th><th>Version</th><th>Date Range</th><th>Resolution</th><th>Notes</th></tr></thead>
        <tbody>
          {% for s in sources %}
          <tr>
            <td>{{ s.name }}</td>
            <td>{{ s.version }}</td>
            <td>{{ s.date_range }}</td>
            <td>{{ s.resolution }}</td>
            <td>{{ s.notes }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  </main>

  <footer class="vs-footer">
    <div>© {{ year }} VerdeSat • Data: Sentinel‑2, Esri LULC 10 m, GLOBIO MSA 2015 (300 m), EFA/EFT 300 m (where available), WDPA/KBA</div>
    <div class="page-num">Page <span class="pageNumber"></span> / <span class="totalPages"></span></div>
  </footer>
</body>
</html>
